@startuml
participant "<<class>>\nFinTrack" as FT
participant "<<class>>\nParser" as P
participant ":CsvStorage" as CS
participant ":FinanceManager" as FM
participant "<<class>>\nUi" as UI

FT -> UI: waitForInput()
UI --> FT: "export data.csv"

FT -> P: returnFirstWord(input)
P --> FT: "export"

FT -> P: parseExport(input)
P -> P: validate filename format (letters, numbers, hyphens, underscores, dots)
P -> P: prevent directory separators (/,\\)
P -> P: automatically append .csv extension if missing
P --> FT: exportPath

create CS
FT -> CS: new CsvStorage()

FT -> FM: getIncomesView()
FT -> FM: getExpensesView()
FT -> FM: getTotalIncome()
FT -> FM: getTotalExpense()
FT -> FM: getBalance()

FT -> CS: export(exportPath, incomes, expenses,\ntotalIncome, totalExpense, balance)

CS -> CS: validate file doesn't already exist

CS -> CS: write CSV header (Type,Date,Amount,Category,Description)

loop for each income
    CS -> CS: write entry with INCOME type, escape commas in description
end

loop for each expense
    CS -> CS: write entry with EXPENSE type, escape commas in description
end

CS -> CS: writeSummarySection(totalIncome,\ntotalExpense, balance)

CS --> FT: success

FT -> UI: printExportSuccess(exportPath)

group Exception Handling
    alt file already exists
        FT -> UI: printError("File already exists")
    else file open in another program
        FT -> UI: printError("File open in another program")
    else write permissions
        FT -> UI: printError("No write permissions")
    else invalid filename
        FT -> UI: printError("Invalid filename")
    end
end
@enduml
